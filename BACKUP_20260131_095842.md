# Database Backup - 2026-01-31 09:58:42

## Backup Information

**Timestamp:** 2026-01-31 09:58:42
**Migration Point:** 096_simplify_force_delete_dues_function
**Total Migrations:** 96
**Purpose:** Full backup before any changes

## Database State Summary

### Tables (18)
1. **sites** - Site/property management
2. **profiles** - User profiles linked to auth.users
3. **user_site_roles** - Role assignments per site
4. **role_permissions** - Permission system
5. **fiscal_periods** - Financial period management
6. **unit_types** - Unit category definitions
7. **units** - Individual property units
8. **accounts** - Financial accounts with multi-currency
9. **budget_categories** - Budget line items
10. **dues** - Monthly charges to units
11. **payments** - Payment records
12. **ledger_entries** - Complete financial ledger
13. **debt_workflows** - Debt collection tracking
14. **balance_transfers** - Unit balance adjustments
15. **support_tickets** - Support system
16. **category_templates** - Budget templates
17. **penalty_settings** - Late payment penalties
18. **app_translations** - Multi-language support

### Data Sizes
- **dues:** 2.6 MB (largest table)
- **payments:** 584 KB
- **ledger_entries:** 352 KB
- **units:** 264 KB
- **budget_categories:** 224 KB
- **accounts:** 184 KB
- **Other tables:** < 160 KB each

### Views (5)
1. **unit_balances** - Current balance per unit
2. **monthly_income_expenses** - Income/expense summary
3. **financial_summary** - Overall financial status
4. **budget_vs_actual** - Budget comparison
5. **overdue_debt_alerts** - Debt notifications

### Key Functions (31)
- **apply_unit_payment()** - Process payments to dues
- **set_unit_monthly_due()** - Set individual unit dues
- **set_varied_unit_monthly_dues()** - Set varied dues
- **generate_dues_if_missing()** - Auto-generate dues
- **force_delete_dues()** - Delete dues with keyword
- **update_account_balance()** - Account balance updates
- **calculate_unit_balance()** - Unit balance calculation
- **create_internal_transfer()** - Account transfers
- **record_opening_balance()** - Set opening balances
- **Plus 22 more functions**

### Triggers (16)
- Payment insertion → Ledger creation
- Ledger changes → Budget updates
- Dues changes → Balance recalculation
- Payment deletion → Cleanup cascade
- Currency conversion handling
- Automatic balance maintenance

## Restoration Options

### Option 1: Full Reset to This Point
```bash
# Reset entire database to migration 096
supabase db reset
supabase migration up --to 20260131072503
```

### Option 2: Restore Specific Table Schema
```sql
-- Use BACKUP_SCHEMA_20260131_095842.sql as reference
-- Extract specific CREATE TABLE statements
-- Run them after dropping existing table
```

### Option 3: Roll Back Last N Migrations
```bash
# Check current migration
supabase migration list

# Roll back specific number of migrations
supabase db reset
supabase migration up --to [TARGET_MIGRATION_ID]
```

### Option 4: Restore from Schema File
```bash
# If you need to recreate from scratch
psql $DATABASE_URL < BACKUP_SCHEMA_20260131_095842.sql
```

## Important Notes

1. **Data Safety:** This backup represents the state BEFORE any new changes
2. **Migration 096:** Last applied migration is the simplified force_delete_dues function
3. **Multi-Currency:** System supports multiple currencies with exchange rates
4. **RLS Active:** All tables have Row Level Security enabled
5. **Functions:** All database functions are operational and tested

## Files in This Backup

- `BACKUP_20260131_095842.md` - This restoration guide (4.5KB)
- `BACKUP_SCHEMA_20260131_095842.sql` - Complete schema snapshot (16KB)
- `supabase/migrations/` - All 96 migration files

## What to Do If You Need to Restore

1. **Identify the Issue:** Determine what needs to be restored
2. **Choose Method:** Pick appropriate restoration option above
3. **Backup Current:** Consider backing up current state first
4. **Execute Restore:** Run chosen restoration commands
5. **Verify:** Check that data and functions work as expected
6. **Test:** Run application to ensure everything functions

## Support

If you encounter issues:
- Check migration files in `supabase/migrations/`
- Review schema in `BACKUP_SCHEMA_20260131_095842.sql`
- Verify RLS policies are correctly applied
- Test functions individually using SQL queries

---

**Created:** 2026-01-31 09:58:42
**Safe to Delete After:** Keep indefinitely as rollback point
